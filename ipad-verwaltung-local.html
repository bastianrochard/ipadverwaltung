<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="iPad-Verwaltung">
  <meta name="theme-color" content="#E85D4D">
  <title>iPad Verwaltung - Gymnasium Rutesheim</title>
  
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect fill='%23E85D4D' width='192' height='192' rx='32'/%3E%3Cpath fill='white' d='M48 64h96v64H48z' stroke='white' stroke-width='8' rx='8'/%3E%3Ccircle cx='96' cy='144' r='8' fill='white'/%3E%3C/svg%3E">
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    .rutesheim-red { color: #E85D4D; }
    .bg-rutesheim-red { background-color: #E85D4D; }
    .border-rutesheim-red { border-color: #E85D4D; }
    .hover\:bg-rutesheim-red:hover { background-color: #E85D4D; }
    
    @media (display-mode: standalone) {
      body { padding-top: env(safe-area-inset-top); }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    const App = () => {
      const [devices, setDevices] = useState(() => {
        const saved = localStorage.getItem('ipad-verwaltung-daten');
        return saved ? JSON.parse(saved) : [
          { id: 1, seriennummer: 'DMXYZ123ABC', modell: 'iPad 9. Gen', nutzer: 'Max Mustermann', klasse: '7a', nutzungsbeginn: '2024-09-01', vereinbarung: true, quelle: 'manuell' },
          { id: 2, seriennummer: 'DMXYZ456DEF', modell: 'iPad 10. Gen', nutzer: 'Anna Schmidt', klasse: '7a', nutzungsbeginn: '2024-09-01', vereinbarung: false, quelle: 'manuell' },
          { id: 3, seriennummer: 'DMXYZ789GHI', modell: 'iPad Air', nutzer: 'Leon Weber', klasse: '8b', nutzungsbeginn: '2024-08-15', vereinbarung: true, quelle: 'manuell' }
        ];
      });

      const [search, setSearch] = useState('');
      const [classFilter, setClassFilter] = useState('alle');
      const [showDashboard, setShowDashboard] = useState(true);
      const [showForm, setShowForm] = useState(false);
      const [showImportInfo, setShowImportInfo] = useState(false);
      const [editId, setEditId] = useState(null);
      const [selectedIds, setSelectedIds] = useState([]);
      const [lastSaved, setLastSaved] = useState(new Date().toLocaleTimeString('de-DE'));
      const [lastBackup, setLastBackup] = useState(localStorage.getItem('last-backup-date'));
      const [showImportDialog, setShowImportDialog] = useState(true);
      const [showInstallPrompt, setShowInstallPrompt] = useState(false);
      const [deferredPrompt, setDeferredPrompt] = useState(null);
      const [formData, setFormData] = useState({
        seriennummer: '', modell: '', nutzer: '', klasse: '',
        nutzungsbeginn: new Date().toISOString().split('T')[0], vereinbarung: false
      });

      useEffect(() => {
        localStorage.setItem('ipad-verwaltung-daten', JSON.stringify(devices));
        setLastSaved(new Date().toLocaleTimeString('de-DE'));
      }, [devices]);

      useEffect(() => {
        const hasData = localStorage.getItem('ipad-verwaltung-daten');
        if (hasData && JSON.parse(hasData).length > 0) {
          setShowImportDialog(false);
        }
        
        // Service Worker registrieren
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('./sw.js')
            .then(() => console.log('Service Worker registriert'))
            .catch(err => console.log('Service Worker Fehler:', err));
        }

        // Install Prompt
        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          setDeferredPrompt(e);
          setShowInstallPrompt(true);
        });

        // Check Backup-Alter
        const lastBackupDate = localStorage.getItem('last-backup-date');
        if (lastBackupDate) {
          const daysSince = Math.floor((Date.now() - new Date(lastBackupDate)) / (1000 * 60 * 60 * 24));
          if (daysSince > 7) {
            setTimeout(() => {
              if (confirm('⚠️ Letztes Backup ist ' + daysSince + ' Tage her!\n\nJetzt Backup in Nextcloud erstellen?')) {
                exportCSV();
              }
            }, 2000);
          }
        }
      }, []);

      useEffect(() => {
        const handleBeforeUnload = (e) => {
          if (devices.length > 0) {
            e.preventDefault();
            e.returnValue = '';
            return '';
          }
        };
        
        window.addEventListener('beforeunload', handleBeforeUnload);
        return () => window.removeEventListener('beforeunload', handleBeforeUnload);
      }, [devices]);

      const classes = useMemo(() => 
        ['alle', ...new Set(devices.map(d => d.klasse).filter(k => k))].sort(), [devices]
      );

      const filtered = useMemo(() => 
        devices.filter(d => {
          const matchSearch = [d.seriennummer, d.modell, d.nutzer, d.klasse]
            .some(field => field.toLowerCase().includes(search.toLowerCase()));
          const matchClass = classFilter === 'alle' || d.klasse === classFilter;
          return matchSearch && matchClass;
        }), [devices, search, classFilter]
      );

      const stats = useMemo(() => {
        const byClass = {};
        devices.forEach(d => byClass[d.klasse] = (byClass[d.klasse] || 0) + 1);
        return {
          total: devices.length,
          agreements: devices.filter(d => d.vereinbarung).length,
          byClass: Object.entries(byClass).sort()
        };
      }, [devices]);

      const nextClass = (klasse) => {
        if (!klasse) return klasse;
        klasse = klasse.trim();
        if (klasse === 'J1') return 'J2';
        if (klasse === 'J2') return 'Abschluss';
        const match = klasse.match(/^(\d+)([a-z]?)$/i);
        if (match) {
          const level = parseInt(match[1]);
          const letter = match[2].toLowerCase();
          if (level === 11) return 'J1';
          return `${level + 1}${letter}`;
        }
        return klasse;
      };

      const handleSave = () => {
        if (!formData.seriennummer || !formData.modell || !formData.nutzer) {
          alert('Bitte Seriennummer, Modell und Nutzer ausfüllen');
          return;
        }
        if (editId) {
          setDevices(devices.map(d => d.id === editId ? { ...formData, id: editId, quelle: d.quelle } : d));
        } else {
          const newId = Math.max(0, ...devices.map(d => d.id)) + 1;
          setDevices([...devices, { ...formData, id: newId, quelle: 'manuell' }]);
        }
        resetForm();
      };

      const resetForm = () => {
        setFormData({ seriennummer: '', modell: '', nutzer: '', klasse: '', 
                      nutzungsbeginn: new Date().toISOString().split('T')[0], vereinbarung: false });
        setEditId(null);
        setShowForm(false);
      };

      const handleEdit = (device) => {
        setFormData({ ...device });
        setEditId(device.id);
        setShowForm(true);
      };

      const handleDelete = (id) => {
        if (confirm('Gerät wirklich löschen?')) {
          setDevices(devices.filter(d => d.id !== id));
        }
      };

      const toggleAgreement = (id) => {
        setDevices(devices.map(d => d.id === id ? { ...d, vereinbarung: !d.vereinbarung } : d));
      };

      const updateClass = (id, newClass) => {
        setDevices(devices.map(d => d.id === id ? { ...d, klasse: newClass } : d));
      };

      const toggleSelectAll = () => {
        if (selectedIds.length === filtered.length) {
          setSelectedIds([]);
        } else {
          setSelectedIds(filtered.map(d => d.id));
        }
      };

      const toggleSelect = (id) => {
        setSelectedIds(prev => 
          prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]
        );
      };

      const deleteSelected = () => {
        if (selectedIds.length === 0) {
          alert('Keine Geräte ausgewählt');
          return;
        }
        if (confirm(`${selectedIds.length} Geräte wirklich löschen?`)) {
          setDevices(devices.filter(d => !selectedIds.includes(d.id)));
          setSelectedIds([]);
        }
      };

      const setAgreementSelected = (value) => {
        if (selectedIds.length === 0) {
          alert('Keine Geräte ausgewählt');
          return;
        }
        setDevices(devices.map(d => 
          selectedIds.includes(d.id) ? { ...d, vereinbarung: value } : d
        ));
      };

      const handleYearChange = () => {
        if (confirm('Schuljahreswechsel durchführen? Alle Schüler werden eine Klasse höher gestuft.')) {
          setDevices(devices.map(d => ({ ...d, klasse: nextClass(d.klasse) })));
          alert('Schuljahreswechsel erfolgreich!');
        }
      };

      const exportCSV = () => {
        const header = 'SerialNumber;Model;username;Klasse;Nutzungsbeginn;Vereinbarung\n';
        const rows = devices.map(d => 
          `${d.seriennummer};${d.modell};${d.nutzer};${d.klasse || ''};${d.nutzungsbeginn};${d.vereinbarung ? 'Ja' : 'Nein'}`
        ).join('\n');
        const blob = new Blob([header + rows], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ipad-backup-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        
        localStorage.setItem('last-backup-date', new Date().toISOString());
        setLastBackup(new Date().toISOString());
        alert('✅ Backup erstellt!\n\n💡 Speichere die Datei jetzt in deinem Nextcloud-Ordner für automatische Synchronisation.');
      };

      const importCSV = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const text = event.target.result;
            const lines = text.split(/\r?\n/).filter(l => l.trim());
            
            const delimiter = lines[0].includes(';') ? ';' : ',';
            const headerRaw = lines[0].split(delimiter).map(h => h.trim().replace(/['"]/g, '').toLowerCase());
            
            const serialIdx = headerRaw.findIndex(h => h.includes('serial'));
            const modelIdx = headerRaw.findIndex(h => h.includes('model'));
            const userIdx = headerRaw.findIndex(h => h.includes('user') || h.includes('nutzer') || h.includes('name'));
            const classIdx = headerRaw.findIndex(h => h.includes('klasse') || h.includes('class'));
            const dateIdx = headerRaw.findIndex(h => h.includes('datum') || h.includes('date') || h.includes('beginn'));
            const agrIdx = headerRaw.findIndex(h => h.includes('vereinbarung') || h.includes('agreement'));

            const newDevices = [];
            for (let i = 1; i < lines.length; i++) {
              if (!lines[i].trim()) continue;
              
              const values = lines[i].split(delimiter).map(v => v.trim().replace(/^["']|["']$/g, ''));
              
              if (values.length > 1 && values[serialIdx]) {
                const newId = Math.max(0, ...devices.map(d => d.id), ...newDevices.map(d => d.id)) + 1;
                newDevices.push({
                  id: newId,
                  seriennummer: values[serialIdx] || 'N/A',
                  modell: values[modelIdx] || 'N/A',
                  nutzer: values[userIdx] || 'N/A',
                  klasse: values[classIdx] || '',
                  nutzungsbeginn: values[dateIdx] || new Date().toISOString().split('T')[0],
                  vereinbarung: (values[agrIdx]?.toLowerCase() === 'ja' || values[agrIdx]?.toLowerCase() === 'true') || false,
                  quelle: 'Aus Jamf'
                });
              }
            }
            
            if (newDevices.length > 0) {
              setDevices([...devices, ...newDevices]);
              setShowImportDialog(false);
              alert(`✅ ${newDevices.length} Geräte erfolgreich importiert!`);
            } else {
              alert('⚠️ Keine gültigen Daten gefunden. Bitte CSV-Format prüfen.');
            }
          } catch (err) {
            console.error('Import-Fehler:', err);
            alert('❌ Fehler beim Import: ' + err.message);
          }
        };
        reader.readAsText(file, 'UTF-8');
        e.target.value = '';
      };

      const triggerImport = () => {
        document.getElementById('fileImportInput').click();
      };

      const handleInstallClick = async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          setDeferredPrompt(null);
          setShowInstallPrompt(false);
        }
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 p-4 md:p-6">
          <div className="max-w-7xl mx-auto">
            
            {/* PWA Install Banner */}
            {showInstallPrompt && (
              <div className="mb-4 p-4 bg-blue-500 text-white rounded-lg flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <span className="text-2xl">📱</span>
                  <div>
                    <div className="font-semibold">App installieren?</div>
                    <div className="text-sm opacity-90">Schneller Zugriff vom Homescreen</div>
                  </div>
                </div>
                <div className="flex gap-2">
                  <button onClick={handleInstallClick} className="px-4 py-2 bg-white text-blue-600 rounded-lg font-medium">
                    Installieren
                  </button>
                  <button onClick={() => setShowInstallPrompt(false)} className="px-4 py-2 bg-blue-600 text-white rounded-lg">
                    Später
                  </button>
                </div>
              </div>
            )}

            {/* Import Dialog beim Start */}
            {showImportDialog && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-2xl shadow-2xl p-6 md:p-8 max-w-md w-full">
                  <h2 className="text-2xl font-bold text-gray-800 mb-4">Willkommen! 👋</h2>
                  <p className="text-gray-600 mb-6">
                    Möchten Sie ein aktuelles Backup aus Ihrer Nextcloud importieren?
                  </p>
                  <div className="flex flex-col gap-3">
                    <button onClick={triggerImport} 
                      className="w-full bg-rutesheim-red text-white py-3 rounded-lg hover:opacity-90 font-medium">
                      📁 Backup aus Nextcloud importieren
                    </button>
                    <button onClick={() => setShowImportDialog(false)}
                      className="w-full bg-gray-200 text-gray-700 py-3 rounded-lg hover:bg-gray-300 font-medium">
                      Später / Ohne Backup starten
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* Hidden file input */}
            <input type="file" id="fileImportInput" accept=".csv" onChange={importCSV} className="hidden" />

            <div className="bg-white rounded-2xl shadow-xl p-4 md:p-8 mb-6">
              
              {/* Header */}
              <div className="flex flex-col md:flex-row md:items-center justify-between mb-6 pb-4 border-b-2 border-rutesheim-red gap-4">
                <div>
                  <h1 className="text-2xl md:text-3xl font-bold text-gray-800">iPad-Verwaltung</h1>
                  <p className="text-gray-500 text-sm">Gymnasium Rutesheim • Jamf School</p>
                </div>
                <div className="flex flex-col md:flex-row items-start md:items-center gap-3">
                  <div className="text-sm">
                    <div className="text-xs text-gray-500">Gespeichert: {lastSaved}</div>
                    {lastBackup && (
                      <div className="text-xs text-gray-500">
                        Backup: {new Date(lastBackup).toLocaleDateString('de-DE')}
                      </div>
                    )}
                  </div>
                  <button onClick={() => setShowDashboard(!showDashboard)}
                    className="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition text-sm">
                    Dashboard {showDashboard ? 'ausblenden' : 'anzeigen'}
                  </button>
                </div>
              </div>

              {/* Dashboard */}
              {showDashboard && (
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 rounded-xl border-l-4 border-rutesheim-red">
                  <div className="bg-white p-4 rounded-lg shadow-sm">
                    <div className="text-sm text-gray-500">Geräte gesamt</div>
                    <div className="text-3xl font-bold text-gray-800">{stats.total}</div>
                  </div>
                  <div className="bg-white p-4 rounded-lg shadow-sm">
                    <div className="text-sm text-gray-500">Vereinbarungen</div>
                    <div className="text-3xl font-bold text-green-600">{stats.agreements}</div>
                    <div className="text-xs text-gray-400">von {stats.total}</div>
                  </div>
                  <div className="bg-white p-4 rounded-lg shadow-sm col-span-1 md:col-span-2">
                    <div className="text-sm text-gray-500 mb-2">Geräte pro Klasse</div>
                    <div className="flex flex-wrap gap-2">
                      {stats.byClass.map(([k, c]) => (
                        <span key={k} className="px-3 py-1 bg-gray-100 rounded-full text-sm border border-rutesheim-red border-opacity-30">
                          {k || 'Ohne Klasse'}: {c}
                        </span>
                      ))}
                    </div>
                  </div>
                </div>
              )}

              {/* Toolbar */}
              <div className="flex flex-wrap gap-3 mb-6">
                <input type="text" placeholder="Suche..." value={search} onChange={(e) => setSearch(e.target.value)}
                  className="flex-1 min-w-[200px] px-4 py-2 border rounded-lg focus:ring-2 focus:ring-rutesheim-red" />
                
                <select value={classFilter} onChange={(e) => setClassFilter(e.target.value)}
                  className="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-rutesheim-red">
                  {classes.map(c => <option key={c} value={c}>{c === 'alle' ? 'Alle Klassen' : c ? `Klasse ${c}` : 'Ohne Klasse'}</option>)}
                </select>

                <button onClick={() => setShowForm(true)} className="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 whitespace-nowrap">
                  + Neu
                </button>

                <label className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 cursor-pointer whitespace-nowrap">
                  Import
                  <input type="file" accept=".csv" onChange={importCSV} className="hidden" />
                </label>

                <button onClick={exportCSV} className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 whitespace-nowrap">
                  💾 Backup
                </button>

                <button onClick={handleYearChange} className="px-4 py-2 bg-rutesheim-red text-white rounded-lg hover:opacity-90 whitespace-nowrap">
                  Schuljahr+
                </button>
              </div>

              {/* Massenaktionen */}
              {selectedIds.length > 0 && (
                <div className="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200 flex flex-wrap gap-3 items-center">
                  <span className="font-semibold text-gray-700">{selectedIds.length} ausgewählt:</span>
                  <button onClick={deleteSelected} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">
                    Löschen
                  </button>
                  <button onClick={() => setAgreementSelected(true)} className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                    Vereinbarung ✓
                  </button>
                  <button onClick={() => setAgreementSelected(false)} className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm">
                    Vereinbarung ✗
                  </button>
                </div>
              )}

              <button onClick={() => setShowImportInfo(!showImportInfo)} className="text-sm text-gray-600 hover:text-rutesheim-red mb-4">
                ℹ️ CSV-Import Anleitung & Nextcloud-Workflow
              </button>

              {/* Import Info */}
              {showImportInfo && (
                <div className="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                  <h4 className="font-semibold mb-3 text-lg">📋 Nextcloud-Workflow</h4>
                  
                  <div className="mb-4 p-3 bg-white rounded">
                    <h5 className="font-semibold text-sm mb-2">1️⃣ Einmalig einrichten:</h5>
                    <ul className="text-sm space-y-1 text-gray-700">
                      <li>• Ordner in Nextcloud erstellen: <code className="bg-gray-100 px-2 py-1 rounded">/iPad-Verwaltung/</code></li>
                      <li>• Nextcloud-App auf iPad installieren</li>
                      <li>• Automatische Synchronisation aktivieren</li>
                    </ul>
                  </div>

                  <div className="mb-4 p-3 bg-white rounded">
                    <h5 className="font-semibold text-sm mb-2">2️⃣ Täglicher Workflow:</h5>
                    <ul className="text-sm space-y-1 text-gray-700">
                      <li>• Arbeite in der App (Daten werden automatisch gespeichert)</li>
                      <li>• Klicke "💾 Backup" → CSV wird heruntergeladen</li>
                      <li>• Speichere in Nextcloud-Ordner (wird automatisch synchronisiert)</li>
                      <li>• Auf anderem Gerät: "Import" → CSV aus Nextcloud wählen</li>
                    </ul>
                  </div>

                  <h4 className="font-semibold mb-2 mt-4">📄 CSV-Format:</h4>
                  <div className="bg-white p-3 rounded font-mono text-xs">
                    SerialNumber;Model;username;Klasse;Nutzungsbeginn;Vereinbarung<br/>
                    DMXYZ123ABC;iPad 9. Gen;max.mustermann;7a;2024-09-01;Ja
                  </div>

                  <p className="text-sm text-gray-600 mt-3">
                    ✅ Trennzeichen: <strong>Semikolon (;)</strong><br/>
                    ✅ Backup-Dateien können direkt importiert werden
                  </p>
                </div>
              )}

              {/* Form */}
              {showForm && (
                <div className="mb-6 p-6 bg-gray-50 rounded-xl border-l-4 border-rutesheim-red">
                  <div className="flex justify-between mb-4">
                    <h3 className="text-xl font-bold">{editId ? 'Bearbeiten' : 'Neu hinzufügen'}</h3>
                    <button onClick={resetForm} className="text-gray-500 hover:text-gray-700 text-2xl">×</button>
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium mb-1">Seriennummer *</label>
                      <input type="text" value={formData.seriennummer} 
                        onChange={(e) => setFormData({...formData, seriennummer: e.target.value})}
                        className="w-full px-4 py-2 border rounded-lg" placeholder="DMXYZ123ABC" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Modell *</label>
                      <input type="text" value={formData.modell}
                        onChange={(e) => setFormData({...formData, modell: e.target.value})}
                        className="w-full px-4 py-2 border rounded-lg" placeholder="iPad 10. Gen" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Nutzer *</label>
                      <input type="text" value={formData.nutzer}
                        onChange={(e) => setFormData({...formData, nutzer: e.target.value})}
                        className="w-full px-4 py-2 border rounded-lg" placeholder="Max Mustermann" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Klasse</label>
                      <input type="text" value={formData.klasse}
                        onChange={(e) => setFormData({...formData, klasse: e.target.value})}
                        className="w-full px-4 py-2 border rounded-lg" placeholder="7a" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Nutzungsbeginn</label>
                      <input type="date" value={formData.nutzungsbeginn}
                        onChange={(e) => setFormData({...formData, nutzungsbeginn: e.target.value})}
                        className="w-full px-4 py-2 border rounded-lg" />
                    </div>
                    <div className="flex items-center">
                      <label className="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" checked={formData.vereinbarung}
                          onChange={(e) => setFormData({...formData, vereinbarung: e.target.checked})}
                          className="w-5 h-5 rounded" />
                        <span className="text-sm font-medium">Nutzungsvereinbarung</span>
                      </label>
                    </div>
                    <div className="md:col-span-2 flex gap-3">
                      <button onClick={handleSave} className="flex-1 bg-gray-800 text-white py-2 rounded-lg hover:bg-gray-700">
                        {editId ? 'Speichern' : 'Hinzufügen'}
                      </button>
                      <button onClick={resetForm} className="px-6 bg-gray-200 py-2 rounded-lg hover:bg-gray-300">
                        Abbrechen
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Count */}
              <div className="text-sm text-gray-500 mb-3">{filtered.length} von {devices.length} Geräten</div>

              {/* Table */}
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead>
                    <tr className="bg-gray-100 border-b-2 border-rutesheim-red">
                      <th className="px-2 md:px-4 py-3 text-center">
                        <input type="checkbox" 
                          checked={selectedIds.length === filtered.length && filtered.length > 0}
                          onChange={toggleSelectAll}
                          className="w-5 h-5 cursor-pointer" />
                      </th>
                      <th className="px-2 md:px-4 py-3 text-left text-sm font-semibold">Serial</th>
                      <th className="px-2 md:px-4 py-3 text-left text-sm font-semibold hidden md:table-cell">Modell</th>
                      <th className="px-2 md:px-4 py-3 text-left text-sm font-semibold">Nutzer</th>
                      <th className="px-2 md:px-4 py-3 text-left text-sm font-semibold">Klasse</th>
                      <th className="px-2 md:px-4 py-3 text-left text-sm font-semibold hidden lg:table-cell">Beginn</th>
                      <th className="px-2 md:px-4 py-3 text-center text-sm font-semibold">Vereinb.</th>
                      <th className="px-2 md:px-4 py-3 text-left text-sm font-semibold hidden lg:table-cell">Quelle</th>
                      <th className="px-2 md:px-4 py-3 text-center text-sm font-semibold">Aktionen</th>
                    </tr>
                  </thead>
                  <tbody>
                    {filtered.map((d, i) => (
                      <tr key={d.id} className={`border-b hover:bg-gray-50 ${i % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                        <td className="px-2 md:px-4 py-3 text-center">
                          <input type="checkbox"
                            checked={selectedIds.includes(d.id)}
                            onChange={() => toggleSelect(d.id)}
                            className="w-5 h-5 cursor-pointer" />
                        </td>
                        <td className="px-2 md:px-4 py-3 font-mono text-xs md:text-sm">{d.seriennummer}</td>
                        <td className="px-2 md:px-4 py-3 text-sm text-gray-600 hidden md:table-cell">{d.modell}</td>
                        <td className="px-2 md:px-4 py-3 text-sm">{d.nutzer}</td>
                        <td className="px-2 md:px-4 py-3">
                          <input type="text" value={d.klasse || ''}
                            onChange={(e) => updateClass(d.id, e.target.value)}
                            className="w-16 md:w-20 px-2 py-1 border rounded text-sm focus:ring-2 focus:ring-rutesheim-red"
                            placeholder="7a" />
                        </td>
                        <td className="px-2 md:px-4 py-3 text-sm text-gray-600 hidden lg:table-cell">
                          {new Date(d.nutzungsbeginn).toLocaleDateString('de-DE')}
                        </td>
                        <td className="px-2 md:px-4 py-3 text-center">
                          <input type="checkbox" checked={d.vereinbarung} onChange={() => toggleAgreement(d.id)}
                            className="w-5 h-5 cursor-pointer" />
                        </td>
                        <td className="px-2 md:px-4 py-3 text-sm hidden lg:table-cell">
                          <span className={`px-2 py-1 rounded-full text-xs ${d.quelle === 'Aus Jamf' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-700'}`}>
                            {d.quelle || 'manuell'}
                          </span>
                        </td>
                        <td className="px-2 md:px-4 py-3">
                          <div className="flex justify-center gap-1 md:gap-2">
                            <button onClick={() => handleEdit(d)} className="p-1 md:p-2 text-blue-600 hover:bg-blue-100 rounded" title="Bearbeiten">✏️</button>
                            <button onClick={() => handleDelete(d.id)} className="p-1 md:p-2 text-red-600 hover:bg-red-100 rounded" title="Löschen">🗑️</button>
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              {filtered.length === 0 && (
                <div className="text-center py-12 text-gray-500">Keine Geräte gefunden</div>
              )}
            </div>

            <div className="text-center text-sm text-gray-500 bg-white rounded-lg p-4 shadow">
              💾 <strong>Nextcloud-Sync:</strong> Klicke "💾 Backup" und speichere die CSV in deinem Nextcloud-Ordner.<br/>
              Die App funktioniert auch offline! Daten werden lokal gespeichert.
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>

  <script>
    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('Service Worker registered'))
          .catch(err => console.log('Service Worker error:', err));
      });
    }
  </script>
</body>
</html>